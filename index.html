<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Distress Thermometer</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#005588">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3063/3063176.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        /* Global Styles */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --primary-bg: #dcf0fd; --secondary-bg: #daebfc; --tertiary-bg: #edf6fc;
            --primary-color: #005588; --accent-color: #004466; --text-color: #111;
            --button-color: #005588; --button-hover-color: #004466;
            --border-radius: 12px; --transition-speed: 0.3s ease;
        }
        body { font-family: 'Poppins', sans-serif; line-height: 1.6; background-color: var(--primary-bg); color: var(--text-color); padding: 1.5rem; }
        .container { max-width: 800px; margin: 0 auto; background-color: var(--secondary-bg); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); padding: 1.5rem; border-radius: var(--border-radius); }
        h1, h2, h3, h4 { color: var(--primary-color); margin-top: 1.5rem; margin-bottom: 1rem; }
        label { font-weight: 600; display: block; margin-top: 1rem; }
        input[type="text"], input[type="date"], input[type="time"] { width: 100%; padding: 0.75rem; margin-top: 0.5rem; border: 1px solid #ccc; border-radius: 8px; background-color: var(--tertiary-bg); font-size: 1rem; box-sizing: border-box; }
        
        /* Slider Components */
        .slider-container { display: flex; flex-direction: column; align-items: center; margin: 20px 0; }
        .horizontal-slider-bar { position: relative; height: 30px; background: linear-gradient(to right, #81C784 0%, #FFB74D 50%, #E57373 100%); border-radius: 15px; width: 100%; cursor: pointer; }
        .horizontal-slider-thumb { position: absolute; top: 50%; width: 42px; height: 42px; background: #fff; border: 4px solid var(--primary-color); border-radius: 50%; transform: translate(-50%, -50%); cursor: grab; left: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .distress-labels { display: flex; justify-content: space-between; width: 100%; padding: 0 10px; font-size: 0.9em; font-weight: bold; color: var(--primary-color); }
        
        /* Checkbox Styles */
        ul { list-style: none; }
        li { display: flex; align-items: flex-start; margin-bottom: 0.5rem; padding: 10px; border-radius: 8px; background: var(--tertiary-bg); transition: 0.2s; }
        .checked-item { background-color: #e6ffe6 !important; }
        input[type="checkbox"] { margin-right: 12px; transform: scale(1.3); accent-color: var(--primary-color); cursor: pointer; }

        /* Output Box */
        .combined-box { margin-top: 2rem; padding: 1.5rem; border: 1px solid #ccc; border-radius: 10px; background: white; }
        textarea { width: 100%; min-height: 150px; padding: 10px; border: 1px solid #eee; border-radius: 5px; font-family: inherit; font-size: 0.95rem; resize: vertical; }

        /* Sync Status Light */
        .status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #syncIndicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; background: #ccc; }
        .online { background: #28a745 !important; }
        .offline { background: #dc3545 !important; }

        .btn { background-color: var(--button-color); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 10px; }
        .btn:disabled { background-color: #ccc; }
        .btn-sync { background-color: #28a745; }
    </style>
</head>
<body>

    <main class="container">
        <div class="status-header">
            <h3>Clinical Assessment</h3>
            <div>
                <span id="syncIndicator"></span> <span id="syncText" style="font-size: 0.8em;">Checking...</span>
            </div>
        </div>

        <section>
            <label for="mrdNumber">MRD Number (Unique Patient ID) <span style="color:red;">*</span>:</label>
            <input type="text" id="mrdNumber" placeholder="e.g. MRD-2025-001" required>

            <label for="guestName">പേര് (Name) <span style="color:red;">*</span>:</label>
            <input type="text" id="guestName" placeholder="Enter full name..." required>

            <div style="display: flex; gap: 1rem;">
                <div style="flex: 1;">
                    <label for="assessmentDate">Date:</label>
                    <input type="date" id="assessmentDate">
                </div>
                <div style="flex: 1;">
                    <label for="assessmentTime">Time:</label>
                    <input type="time" id="assessmentTime">
                </div>
            </div>
        </section>

        <section>
            <h4>Distress Score (0–10)</h4>
            <div class="slider-container">
                <div class="horizontal-slider-bar" id="sliderBar">
                    <div class="horizontal-slider-thumb" id="sliderThumb"></div>
                </div>
                <div id="distressValueDisplay" style="font-size: 2.5rem; font-weight: bold; color: var(--primary-color);">0</div>
            </div>
            <div class="distress-labels">
                <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span>
            </div>
        </section>

        <section>
            <h3>പ്രശ്ന പട്ടിക (Concerns)</h3>
            <ul id="problemList">
                <li><input type="checkbox" class="concern-cb" value="വേദന"> <span>വേദന (Pain)</span></li>
                <li><input type="checkbox" class="concern-cb" value="ഉറക്കം"> <span>ഉറക്കം (Sleep)</span></li>
                <li><input type="checkbox" class="concern-cb" value="ക്ഷീണം"> <span>ക്ഷീണം (Fatigue)</span></li>
                <li><input type="checkbox" class="concern-cb" value="വിഷമം"> <span>വിഷമം (Anxiety)</span></li>
            </ul>
        </section>

        <section class="combined-box" id="combinedBox">
            <h3>Care Plan Summary</h3>
            <textarea id="carePlanBox" readonly placeholder="Fill in details to generate plan..."></textarea>
        </section>

        <button class="btn btn-sync" id="syncBtn">Show & Sync to Patient Thread</button>
        <button class="btn" style="background:#6c757d" onclick="location.reload()">Reset Form</button>
    </main>

    <script>
        // 1. CONFIGURATION - REPLACE WITH YOUR WEB APP URL
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxSDZtF8m5vawJgrKl17pxB9xWdsKaqk3p0H1o1HtqDoL_6IChyhecn4KgEee7JPLi2-w/exec";

        // 2. INITIALIZATION
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

        const sliderBar = document.getElementById('sliderBar');
        const sliderThumb = document.getElementById('sliderThumb');
        const distressValueDisplay = document.getElementById('distressValueDisplay');
        const carePlanBox = document.getElementById('carePlanBox');
        const mrdInput = document.getElementById('mrdNumber');
        const nameInput = document.getElementById('guestName');
        const syncBtn = document.getElementById('syncBtn');

        let isDragging = false;
        let currentScore = 0;

        window.onload = () => {
            const now = new Date();
            document.getElementById('assessmentDate').value = now.toISOString().split('T')[0];
            document.getElementById('assessmentTime').value = now.toTimeString().slice(0, 5);
            updateNetworkStatus();
        };

        // 3. SLIDER LOGIC
        function updateThumbPosition(xPos) {
            const rect = sliderBar.getBoundingClientRect();
            let offsetX = xPos - rect.left;
            offsetX = Math.max(0, Math.min(offsetX, rect.width));
            
            const percent = (offsetX / rect.width);
            currentScore = Math.round(percent * 10);
            
            sliderThumb.style.left = (percent * 100) + "%";
            distressValueDisplay.textContent = currentScore;
            generateCarePlan();
        }

        sliderBar.addEventListener('mousedown', (e) => { isDragging = true; updateThumbPosition(e.clientX); });
        window.addEventListener('mousemove', (e) => { if (isDragging) updateThumbPosition(e.clientX); });
        window.addEventListener('mouseup', () => isDragging = false);
        // Touch Support
        sliderBar.addEventListener('touchstart', (e) => { isDragging = true; updateThumbPosition(e.touches[0].clientX); });
        window.addEventListener('touchmove', (e) => { if (isDragging) updateThumbPosition(e.touches[0].clientX); });
        window.addEventListener('touchend', () => isDragging = false);

        // 4. CARE PLAN GENERATOR
        function generateCarePlan() {
            const mrd = mrdInput.value;
            const name = nameInput.value;
            const checked = Array.from(document.querySelectorAll('.concern-cb:checked')).map(cb => cb.value);
            
            let rec = currentScore <= 3 ? "Low Distress: Routine support." : (currentScore <= 6 ? "Moderate: Referral needed." : "High: Urgent Psychiatric/Palliative intervention.");
            
            carePlanBox.value = `PATIENT: ${name} (${mrd})\nSCORE: ${currentScore}/10\nCONCERNS: ${checked.join(', ') || 'None'}\nPLAN: ${rec}`;
        }

        // 5. THE SYNC LOGIC (POST TO CHAT)
        syncBtn.addEventListener('click', async () => {
            const mrd = mrdInput.value;
            const name = nameInput.value;

            if (!mrd || !name) {
                alert("Please enter MRD Number and Patient Name.");
                return;
            }

            const payload = {
                patientId: mrd, // Used as threadKey in Apps Script
                patientName: name,
                score: currentScore,
                timestamp: new Date().toLocaleString(),
                carePlan: carePlanBox.value
            };

            syncBtn.disabled = true;
            syncBtn.innerText = "Syncing to Chat...";

            try {
                // Post to Google Apps Script
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });
                
                alert("Assessment synced to Patient Thread!");
            } catch (err) {
                // Save locally if offline
                let queue = JSON.parse(localStorage.getItem('offline_sync') || "[]");
                queue.push(payload);
                localStorage.setItem('offline_sync', JSON.stringify(queue));
                alert("Offline: Saved to Tablet. Will sync when Wi-Fi returns.");
            } finally {
                syncBtn.disabled = false;
                syncBtn.innerText = "Show & Sync to Patient Thread";
            }
        });

        // Update checked items visual
        document.querySelectorAll('.concern-cb').forEach(cb => {
            cb.addEventListener('change', (e) => {
                e.target.parentElement.classList.toggle('checked-item', e.target.checked);
                generateCarePlan();
            });
        });

        // Network Status
        function updateNetworkStatus() {
            const ind = document.getElementById('syncIndicator');
            const txt = document.getElementById('syncText');
            if(navigator.onLine) {
                ind.className = "online"; txt.innerText = "Online";
            } else {
                ind.className = "offline"; txt.innerText = "Offline (Local Save Active)";
            }
        }
        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);
        
        // Update plan when name changes
        mrdInput.addEventListener('input', generateCarePlan);
        nameInput.addEventListener('input', generateCarePlan);

        /**
 * OFFLINE AUTO-SYNC ENGINE
 * Automatically detects internet restoration and pushes queued data.
 */

// 1. Listen for the 'online' event
window.addEventListener('online', async () => {
    console.log("Internet connection restored. Starting Auto-Sync...");
    await processOfflineQueue();
});

// 2. Function to process the queue
async function processOfflineQueue() {
    const queue = JSON.parse(localStorage.getItem('offline_sync') || "[]");
    
    if (queue.length === 0) return;

    console.log(`Found ${queue.length} pending records to sync.`);
    const remainingQueue = [];

    for (const payload of queue) {
        try {
            // Attempt to post to Google Apps Script
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(payload)
            });
            
            console.log(`Successfully synced record for: ${payload.patientName}`);
        } catch (error) {
            console.error("Failed to sync a record, keeping it in queue.", error);
            remainingQueue.push(payload); // Keep it to try again later
        }
    }

    // 3. Update localStorage with only the items that failed (or clear if all succeeded)
    if (remainingQueue.length > 0) {
        localStorage.setItem('offline_sync', JSON.stringify(remainingQueue));
    } else {
        localStorage.removeItem('offline_sync');
        alert("Success: All offline clinical assessments have been synced to Google Chat.");
    }
}

// 4. Initial check when app opens
window.addEventListener('load', () => {
    if (navigator.onLine) {
        processOfflineQueue();
    }
});
    </script>
</body>
</html>
